/*! For license information please see box-and-pointer.min.js.LICENSE.txt */
(()=>{"use strict";var e={720:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getCountOfChar=void 0,t.getCountOfChar=(e,t)=>{let n=0;for(let o=0;o<e.length;o++)e[o]===t&&n++;return n}},641:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SExpression=t.parse=void 0;const s=n(58);Object.defineProperty(t,"parse",{enumerable:!0,get:function(){return s.parse}});const i=o(n(735));t.SExpression=i.default},58:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.parse=void 0;const s=o(n(735)),i=n(196);t.parse=e=>{let t=[],n=[],o=new s.default,r=o,a=[],l=[];for(let o of i.tokenize(e))try{if(o.type===i.TokenType.Bracket){let e=o.value;if(e.dir===i.BracketDirection.Start){if(t.push(e.shape),a[a.length-1]===r){if(void 0===r.tail){r.tail=new s.default,n.push(r),r=r.tail;continue}l.push({pos:o.positionInfo,message:"A dot may only be followed by one value."}),a.pop()}void 0!==r.head&&(r.tail=new s.default,r=r.tail),r.head=new s.default,n.push(r),r=r.head}else{if(a.length>0&&a[a.length-1]===r&&(void 0===r.tail&&l.push({pos:o.positionInfo,message:"A dot must have a value following it."}),a.pop()),t[t.length-1]!==e.shape)for(l.push({pos:o.positionInfo,message:"Mismatched closing bracket."});t.length>0&&t.pop()!==e.shape;)a.length>0&&a[a.length-1]===r&&a.pop(),r.tail=r.tail||null,r=n.pop();if(void 0===r.head){const e=r;r=n.pop(),void 0===r?l.push({pos:o.positionInfo,message:"Missing closing bracket."}):r.head===e?r.head=null:r.tail===e&&(r.tail=null)}else r.tail=r.tail||null,r=n.pop(),void 0===r&&l.push({pos:o.positionInfo,message:"Missing closing bracket."})}}else if(o.type===i.TokenType.Name){if(a.length>0&&a[a.length-1]===r){if(void 0===r.tail){r.tail=o.value;continue}l.push({pos:o.positionInfo,message:"A dot may only be followed by one value."}),a.pop()}void 0!==r.head&&(r.tail=new s.default,r=r.tail),r.head=o.value}else o.type===i.TokenType.Dot&&(void 0===r.head?l.push({pos:o.positionInfo,message:"A dot must have a value preceeding it."}):a.push(r))}catch(e){console.error(e)}return r.tail=r.tail||null,l.length>0&&console.error(l.map((e=>`${e.pos.row}, ${e.pos.col}: ${e.message}`)).join("\n")),o}},735:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(e,t){this.head=e,this.tail=t}toString(){let e="";return this.head instanceof n?e+=`(${this.head.toString()})`:null===this.head?e+="()":e+=this.head,null===this.tail||(this.tail instanceof n?e+=` ${this.tail.toString()}`:e+=` . ${this.tail}`),e}}t.default=n},196:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BracketShape=t.BracketDirection=t.TokenType=t.tokenize=void 0;const o=n(720);t.tokenize=function*(e){let t=0,n=1,r=0,a="";for(;t<e.length;)if(";"===e[t]){for(;"\n"!==e[++t];);t++}else if(" \n\r\t".includes(e[t]))""!==a?(yield new s(i.Name,a,{row:n,col:r}),a="",r+=a.length):"\n"===e[t]&&(n++,r=1),r++,t++;else if("()[]{}".includes(e[t]))""!==a&&(yield new s(i.Name,a,{row:n,col:r}),a="",r+=a.length),yield new s(i.Bracket,l[e[t++]],{row:n,col:r++});else if('"'===e[t]){""!==a&&(yield new s(i.Name,a,{row:n,col:r}),a="",r+=a.length);let l=t+1;for(;l<e.length&&(l=e.indexOf('"',l),-1!==l);){let a=0;for(let t=1;"\\"===e[l-t];t++)a++;if(a%2==0){let a=e.substring(t,l+1);yield new s(i.Name,a,{row:n,col:r});let c=o.getCountOfChar(a,"\n");n+=c,c>0?r=a.length-a.lastIndexOf("\n"):r+=a.length,t=l+1;break}l++}if(-1===l)return}else""===a&&"."===e[t]?(yield new s(i.Dot,".",{row:n,col:r}),r++,t++):a+=e[t++];""!==a&&(yield new s(i.Name,a,{row:n,col:r}),a="",r+=a.length)};class s{constructor(e,t,n){this.type=e,this.value=t,this.positionInfo=n}}var i,r,a;!function(e){e[e.Bracket=0]="Bracket",e[e.Name=1]="Name",e[e.Dot=2]="Dot"}(i=t.TokenType||(t.TokenType={})),function(e){e[e.Start=0]="Start",e[e.End=1]="End"}(r=t.BracketDirection||(t.BracketDirection={})),function(e){e[e.Paren=0]="Paren",e[e.Curly=1]="Curly",e[e.Square=2]="Square"}(a=t.BracketShape||(t.BracketShape={}));const l={"(":{shape:a.Paren,dir:r.Start},")":{shape:a.Paren,dir:r.End},"{":{shape:a.Curly,dir:r.Start},"}":{shape:a.Curly,dir:r.End},"[":{shape:a.Square,dir:r.Start},"]":{shape:a.Square,dir:r.End}}}},t={};function n(o){var s=t[o];if(void 0!==s)return s.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,n),i.exports}(()=>{function e(...e){return{contents:e}}const t=(()=>{const e="DOMContentLoaded",t=new WeakMap,n=[],o=e=>{do{if(e.nextSibling)return!0}while(e=e.parentNode);return!1},s=()=>{n.splice(0).forEach((e=>{!0!==t.get(e[0])&&(t.set(e[0],!0),e[0][e[1]]())}))};document.addEventListener(e,s);class i extends HTMLElement{static withParsedCallback(i,r="parsed"){const{prototype:a}=i,{connectedCallback:l}=a,c=r+"Callback",d=(t,n,o,s)=>{n.disconnect(),o.removeEventListener(e,s),u(t)},u=e=>{n.length||requestAnimationFrame(s),n.push([e,c])};return Object.defineProperties(a,{connectedCallback:{configurable:!0,writable:!0,value(){if(l&&l.apply(this,arguments),c in this&&!t.has(this)){const n=this,{ownerDocument:s}=n;if(t.set(n,!1),"complete"===s.readyState||o(n))u(n);else{const t=()=>d(n,i,s,t);s.addEventListener(e,t);const i=new MutationObserver((()=>{o(n)&&d(n,i,s,t)}));i.observe(n.parentNode,{childList:!0,subtree:!0})}}}},[r]:{configurable:!0,get(){return!0===t.get(this)}}}),i}}return i.withParsedCallback(i)})();var o,s;!function(e){e.Box="BOX",e.Pair="PAIR",e.Tuple="TUPLE",e.List="LIST",e.Lisp="LISP",e.Value="VALUE",e.Pointer="POINTER",e.Empty="EMPTY"}(o||(o={})),function(e){e.Name="name",e.Ref="ref",e.ExplicitTail="explicit-tail",e.ForceRoot="force-root"}(s||(s={}));const i=new Set(Object.values(o));var r;function a(e){return{...e,kind:r.Pointer}}function l(e,t){Object.assign(e,t)}function c(e){return{...e,kind:r.String}}!function(e){e[e.Pointer=0]="Pointer",e[e.String=1]="String",e[e.Rich=2]="Rich",e[e.Empty=3]="Empty"}(r||(r={}));const d={kind:r.Empty};var u=n(641);customElements.define("box-and-pointer",class extends t{constructor(){super(),this.arrowBindings=[],this.slashes=[],this.rows=[],this.objectToPreparedEltBindings=new Map,this.objectToEltBindings=new Map,this.shadow=this.attachShadow({mode:"open"}),this.shadow.innerHTML=""}async parsedCallback(){const e=this.calculateGraphFromDOM();for(const t of e)this.prepareRenderRoot(t);for(const t of e)this.renderFromBoxObject(t,this.pushRow([],[]),!0);for(const e of this.rows)e.querySelector(".bp--box-container:not(.bp--hidden)")&&this.shadow.appendChild(e);const t=jsPlumb.getInstance({Container:this.shadow,PaintStyle:{stroke:"black",strokeWidth:1.5,fill:"none"}}),n=[document.getElementById("box-and-pointer-style").cloneNode()];if(this.hasAttribute("stylesheet")){const e=document.createElement("link");e.rel="stylesheet",e.href=this.getAttribute("stylesheet"),n.push(e)}let o=n.length;for(let e of n)e.addEventListener("load",(()=>0==--o&&t.ready(s)));this.shadow.prepend(...n);const s=()=>{const e=[["Arrow",{location:1,width:8,length:12}],["Label",{location:0,cssClass:"bp--pointer-source"}]];for(const n of this.arrowBindings)"unknown"!==n.side?("Top"===n.side&&(n.to.style.width="2em"),t.connect({source:n.from,target:n.to,anchors:["Center",n.side],overlays:e,connector:"Straight",endpoint:"Blank"}),"Top"===n.side&&(n.to.style.width="")):t.connect({source:n.from,target:n.to,anchors:["Center",["Continuous",{faces:["top","left","bottom"]}]],overlays:e,connector:[n.from.parentElement.parentElement===n.to.parentElement.parentElement?"StateMachine":"Bezier",{curviness:40,proximityLimit:0,margin:.01}],endpoint:"Blank"});for(const e of this.slashes)t.connect({source:e,target:e,anchors:["TopRight","BottomLeft"],connector:"Straight",endpoint:"Blank"});const n=this.getBoundingClientRect();for(const e of this.shadow.querySelectorAll(".jtk-overlay, .jtk-endpoint, .jtk-connector"))e.style.top=+e.style.top.slice(0,-2)-n.top-window.scrollY+"px",e.style.left=+e.style.left.slice(0,-2)-n.left-window.scrollX+"px";this.classList.add("bp--loaded")}}getChildren(e,t=!1){return[...e.childNodes].flatMap((n=>{if(n instanceof HTMLElement)return i.has(n.tagName)?[n]:(console.error("Found unexpected element %o in %o. Did you misspell a tag name?",n,e),[]);switch(n.nodeType){case Node.TEXT_NODE:const o=n.nodeValue?.trim();if(o){if(t)return[...o.matchAll(/\S+/g)].map((e=>e[0]));console.error("Found text %o in %o. Did you mean to use <lisp></lisp>?",n,e)}break;case Node.COMMENT_NODE:break;default:console.error("Found unexpected node %o in %o.",n,e)}return[]}))}search(e,t){const n=new Set,o=e=>{if(!n.has(e)){n.add(e),t(e);for(const t of e.contents)t.kind===r.Pointer&&o(t.target)}};o(e)}calculateGraphFromDOM(){const t={},n=[],i=[],p=new Set,h=Symbol(),f={},g=this.getChildren(this),m=new Set;let b=h;const y=n=>{let i;switch(n.tagName){case o.Box:const[t,...r]=this.getChildren(n,!0);for(const e of r)"string"==typeof e?console.error("Found extraneous text node %o in %o could be interpreted as a value. Did you mean to use <tuple>?",e,n):console.error("Found extraneous element %o in %o. Did you mean to use <tuple>?",e,n);t?i=e("string"==typeof t?c({value:t}):v(t)):(console.error("<box> element %o contains no values, expected one.",n),i=e(d));break;case o.Pair:{const[t,o,...s]=this.getChildren(n,!0);for(const e of s)"string"==typeof e?console.error("Found extraneous text node %o in %o could be interpreted as a value. Did you mean to use <tuple>?",e,n):console.error("Found extraneous element %o in %o. Did you mean to use <tuple>?",e,n);o?t?i=e("string"==typeof t?c({value:t}):v(t),"string"==typeof o?c({value:o}):v(o)):(console.error("<pair> element %o contains no values, expected two.",n),i=e(d,d)):(console.error("<pair> element %o only contains one value, expected two.",n),i=e("string"==typeof t?c({value:t}):v(t),d));break}case o.Tuple:{const t=this.getChildren(n,!0);0===t.length?(console.error("<tuple> element %o contains no values, expected at least one.",n),i=e(d)):i=e(...t.map((e=>"string"==typeof e?c({value:e}):v(e))));break}case o.List:{const t=this.getChildren(n,!0);if(0===t.length)i=e(d);else if(n.hasAttribute(s.ExplicitTail)){const n=t[t.length-1],o="string"==typeof n?c({value:n}):v(n);i=t.slice(0,-1).reduceRight(((t,n)=>e("string"==typeof n?c({value:n}):v(n),null===t?o:a({target:t}))),null)}else i=t.reduceRight(((t,n)=>e("string"==typeof n?c({value:n}):v(n),null===t?d:a({target:t}))),null);break}case o.Lisp:{n.childNodes.forEach((e=>{[Node.TEXT_NODE,Node.COMMENT_NODE].includes(e.nodeType)||console.error("<lisp> elements can only contain text, but found %o in %o.",e,n)}));const t=e=>e instanceof u.SExpression?a({target:o(e)}):null==e?d:c({value:e}),o=n=>e(t(n.head),t(n.tail)),s=(0,u.parse)(n.innerText).head;s instanceof u.SExpression?i=o(s):(console.error("%o is not valid content for a <lisp> element. Did you mean to surround it with parentheses?",n.innerText),i=e(d));break}default:console.error("Found <%s> element, but only <box>, <pair>, <list>, and <lisp> elements are permitted here.",n.tagName.toLowerCase()),i=e(v(n))}const r=n.getAttribute(s.Name);return r&&(t[r]=i),null!==n.getAttribute(s.ForceRoot)&&m.add(i),i},v=e=>{switch(e.tagName){case o.Pointer:{e.childNodes.length>0&&console.error("<pointer> element %o cannot have any children.",e);const o=e.getAttribute(s.Ref);if(!o)return console.error("<pointer> element %o must have a ref attribute, but is missing one.",e),d;if((f[o]??(f[o]=new Set)).add(b),o in t)return a({target:t[o]});const i={kind:r.Pointer};return n.push((()=>{o in t?l(i,a({target:t[o]})):(console.error("<pointer> element %o has ref=%o, but no element with that name exists.",e,o),l(i,d))})),i}case o.Value:return i={content:e},{...i,kind:r.Rich};case o.Empty:return d}var i;return a({target:y(e)})};for(const e of g){const t=e.getAttribute(s.Name);b=t??h;const n=y(e);!t||m.has(n)?i.push(n):p.add(t)}for(const e of m)i.includes(e)||i.push(e);for(const e of n)e();for(;;){const e=new Set([...p].map((e=>t[e])));for(const t of i)this.search(t,(t=>e.delete(t)));if(0===e.size)break;const n=new Map;for(const t of e)n.set(t,0);for(const t of e)this.search(t,(e=>{n.has(e)&&n.set(e,n.get(e)+1)}));const o=[];for(const[e,t]of n.entries())(o[t]??(o[t]=[])).push(e);for(let e=0;e<o.length;e++){const t=o[e];if(t&&t.length>0){if(0===e)for(const e of t)i.push(e);else i.push(t[0]);break}}}return i}pushRow(e,t){const n=document.createElement("div");n.classList.add("bp--row");for(const t of e){const e=t.cloneNode(!0);e.classList.add("bp--hidden"),n.appendChild(e)}if(t.length>0){const e=document.createElement("div");e.classList.add("bp--box-container","bp--hidden","bp--tuple--padding");for(const n of t)e.appendChild(n.cloneNode(!0));n.appendChild(e)}return this.rows.push(n),n}prepareRenderRoot(e){this.objectToPreparedEltBindings.set(e,document.createElement("div"))}renderFromBoxObject(e,t,n=!1){let o=this.objectToPreparedEltBindings.get(e);if(!n&&o)return o;const s=t.childElementCount,i=document.createElement("div");i.classList.add("bp--box-container"),t.appendChild(i),this.objectToEltBindings.set(e,i);const a=e.contents.slice(0,-1),l=e.contents[e.contents.length-1],c=[],d=[];for(let e=0;e<a.length;e++){const t=a[e],n=t===a[0]&&o||document.createElement("div");switch(d.push(n),n.classList.add("bp--box"),i.appendChild(n),t.kind){case r.Empty:this.slashes.push(n);break;case r.String:const o=document.createElement("span");o.classList.add("bp--value-container"),o.innerText=t.value,n.appendChild(o);break;case r.Rich:const s=t.content.cloneNode(!0);s.classList.add("bp--value-container"),n.appendChild(s);break;case r.Pointer:const i=this.objectToEltBindings.get(t.target);i?this.arrowBindings.push({from:n,to:i,side:"unknown"}):c.unshift([t,n,e])}}const u=a.length>0?document.createElement("div"):o??document.createElement("div");switch(u.classList.add("bp--box"),i.appendChild(u),l.kind){case r.Empty:this.slashes.push(u);break;case r.String:const e=document.createElement("span");e.classList.add("bp--value-container"),e.innerText=l.value,u.appendChild(e);break;case r.Rich:const n=l.content.cloneNode(!0);n.classList.add("bp--value-container"),u.appendChild(n);break;case r.Pointer:const o=this.objectToEltBindings.get(l.target);if(o)this.arrowBindings.push({from:u,to:o,side:"unknown"});else{const e=this.renderFromBoxObject(l.target,t);this.arrowBindings.push({from:u,to:e,side:e.classList.contains("bp--box")?"Left":"unknown"})}}for(const[e,n,o]of c){const i=this.objectToEltBindings.get(e.target)??this.renderFromBoxObject(e.target,this.pushRow([...t.children].slice(0,s),d.slice(0,o)));this.arrowBindings.push({from:n,to:i,side:i.classList.contains("bp--box")?"Top":"unknown"})}return d[0]??u}})})()})();