/*! For license information please see box-and-pointer.min.js.LICENSE.txt */
(()=>{"use strict";var e={720:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getCountOfChar=void 0,t.getCountOfChar=(e,t)=>{let n=0;for(let o=0;o<e.length;o++)e[o]===t&&n++;return n}},641:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SExpression=t.parse=void 0;const s=n(58);Object.defineProperty(t,"parse",{enumerable:!0,get:function(){return s.parse}});const r=o(n(735));t.SExpression=r.default},58:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.parse=void 0;const s=o(n(735)),r=n(196);t.parse=e=>{let t=[],n=[],o=new s.default,i=o,a=[],l=[];for(let o of r.tokenize(e))try{if(o.type===r.TokenType.Bracket){let e=o.value;if(e.dir===r.BracketDirection.Start){if(t.push(e.shape),a[a.length-1]===i){if(void 0===i.tail){i.tail=new s.default,n.push(i),i=i.tail;continue}l.push({pos:o.positionInfo,message:"A dot may only be followed by one value."}),a.pop()}void 0!==i.head&&(i.tail=new s.default,i=i.tail),i.head=new s.default,n.push(i),i=i.head}else{if(a.length>0&&a[a.length-1]===i&&(void 0===i.tail&&l.push({pos:o.positionInfo,message:"A dot must have a value following it."}),a.pop()),t[t.length-1]!==e.shape)for(l.push({pos:o.positionInfo,message:"Mismatched closing bracket."});t.length>0&&t.pop()!==e.shape;)a.length>0&&a[a.length-1]===i&&a.pop(),i.tail=i.tail||null,i=n.pop();if(void 0===i.head){const e=i;i=n.pop(),void 0===i?l.push({pos:o.positionInfo,message:"Missing closing bracket."}):i.head===e?i.head=null:i.tail===e&&(i.tail=null)}else i.tail=i.tail||null,i=n.pop(),void 0===i&&l.push({pos:o.positionInfo,message:"Missing closing bracket."})}}else if(o.type===r.TokenType.Name){if(a.length>0&&a[a.length-1]===i){if(void 0===i.tail){i.tail=o.value;continue}l.push({pos:o.positionInfo,message:"A dot may only be followed by one value."}),a.pop()}void 0!==i.head&&(i.tail=new s.default,i=i.tail),i.head=o.value}else o.type===r.TokenType.Dot&&(void 0===i.head?l.push({pos:o.positionInfo,message:"A dot must have a value preceeding it."}):a.push(i))}catch(e){console.error(e)}return i.tail=i.tail||null,l.length>0&&console.error(l.map((e=>`${e.pos.row}, ${e.pos.col}: ${e.message}`)).join("\n")),o}},735:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(e,t){this.head=e,this.tail=t}toString(){let e="";return this.head instanceof n?e+=`(${this.head.toString()})`:null===this.head?e+="()":e+=this.head,null===this.tail||(this.tail instanceof n?e+=` ${this.tail.toString()}`:e+=` . ${this.tail}`),e}}t.default=n},196:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BracketShape=t.BracketDirection=t.TokenType=t.tokenize=void 0;const o=n(720);t.tokenize=function*(e){let t=0,n=1,i=0,a="";for(;t<e.length;)if(";"===e[t]){for(;"\n"!==e[++t];);t++}else if(" \n\r\t".includes(e[t]))""!==a?(yield new s(r.Name,a,{row:n,col:i}),a="",i+=a.length):"\n"===e[t]&&(n++,i=1),i++,t++;else if("()[]{}".includes(e[t]))""!==a&&(yield new s(r.Name,a,{row:n,col:i}),a="",i+=a.length),yield new s(r.Bracket,l[e[t++]],{row:n,col:i++});else if('"'===e[t]){""!==a&&(yield new s(r.Name,a,{row:n,col:i}),a="",i+=a.length);let l=t+1;for(;l<e.length&&(l=e.indexOf('"',l),-1!==l);){let a=0;for(let t=1;"\\"===e[l-t];t++)a++;if(a%2==0){let a=e.substring(t,l+1);yield new s(r.Name,a,{row:n,col:i});let c=o.getCountOfChar(a,"\n");n+=c,c>0?i=a.length-a.lastIndexOf("\n"):i+=a.length,t=l+1;break}l++}if(-1===l)return}else""===a&&"."===e[t]?(yield new s(r.Dot,".",{row:n,col:i}),i++,t++):a+=e[t++];""!==a&&(yield new s(r.Name,a,{row:n,col:i}),a="",i+=a.length)};class s{constructor(e,t,n){this.type=e,this.value=t,this.positionInfo=n}}var r,i,a;!function(e){e[e.Bracket=0]="Bracket",e[e.Name=1]="Name",e[e.Dot=2]="Dot"}(r=t.TokenType||(t.TokenType={})),function(e){e[e.Start=0]="Start",e[e.End=1]="End"}(i=t.BracketDirection||(t.BracketDirection={})),function(e){e[e.Paren=0]="Paren",e[e.Curly=1]="Curly",e[e.Square=2]="Square"}(a=t.BracketShape||(t.BracketShape={}));const l={"(":{shape:a.Paren,dir:i.Start},")":{shape:a.Paren,dir:i.End},"{":{shape:a.Curly,dir:i.Start},"}":{shape:a.Curly,dir:i.End},"[":{shape:a.Square,dir:i.Start},"]":{shape:a.Square,dir:i.End}}}},t={};function n(o){var s=t[o];if(void 0!==s)return s.exports;var r=t[o]={exports:{}};return e[o].call(r.exports,r,r.exports,n),r.exports}(()=>{var e;function t(t){return{...t,kind:e.Single}}function o(t){return{...t,kind:e.Pair}}!function(e){e[e.Single=0]="Single",e[e.Pair=1]="Pair"}(e||(e={}));const s=(()=>{const e="DOMContentLoaded",t=new WeakMap,n=[],o=e=>{do{if(e.nextSibling)return!0}while(e=e.parentNode);return!1},s=()=>{n.splice(0).forEach((e=>{!0!==t.get(e[0])&&(t.set(e[0],!0),e[0][e[1]]())}))};document.addEventListener(e,s);class r extends HTMLElement{static withParsedCallback(r,i="parsed"){const{prototype:a}=r,{connectedCallback:l}=a,c=i+"Callback",d=(t,n,o,s)=>{n.disconnect(),o.removeEventListener(e,s),h(t)},h=e=>{n.length||requestAnimationFrame(s),n.push([e,c])};return Object.defineProperties(a,{connectedCallback:{configurable:!0,writable:!0,value(){if(l&&l.apply(this,arguments),c in this&&!t.has(this)){const n=this,{ownerDocument:s}=n;if(t.set(n,!1),"complete"===s.readyState||o(n))h(n);else{const t=()=>d(n,r,s,t);s.addEventListener(e,t);const r=new MutationObserver((()=>{o(n)&&d(n,r,s,t)}));r.observe(n.parentNode,{childList:!0,subtree:!0})}}}},[i]:{configurable:!0,get(){return!0===t.get(this)}}}),r}}return r.withParsedCallback(r)})();var r,i;!function(e){e.Box="BOX",e.Pair="PAIR",e.List="LIST",e.Lisp="LISP",e.Value="VALUE",e.Pointer="POINTER",e.Empty="EMPTY"}(r||(r={})),function(e){e.Name="name",e.Ref="ref",e.ExplicitTail="explicit-tail",e.ForceRoot="force-root"}(i||(i={}));const a=new Set(Object.values(r));var l;function c(e){return{...e,kind:l.Pointer}}function d(e,t){Object.assign(e,t)}function h(e){return{...e,kind:l.String}}!function(e){e[e.Pointer=0]="Pointer",e[e.String=1]="String",e[e.Rich=2]="Rich",e[e.Empty=3]="Empty"}(l||(l={}));const u={kind:l.Empty};var p=n(641);customElements.define("box-and-pointer",class extends s{constructor(){super(),this.arrowBindings=[],this.slashes=[],this.rows=[],this.objectToPreparedEltBindings=new Map,this.objectToEltBindings=new Map,this.shadow=this.attachShadow({mode:"open"}),this.shadow.innerHTML=""}async parsedCallback(){const e=this.calculateGraphFromDOM();for(const t of e)this.prepareRenderRoot(t);for(const t of e)this.renderFromBoxObject(t,this.pushRow([]),!0);for(let e of this.rows)this.shadow.appendChild(e);const t=jsPlumb.getInstance({Container:this.shadow,PaintStyle:{stroke:"black",strokeWidth:1.5,fill:"none"}}),n=[document.getElementById("box-and-pointer-style").cloneNode()];if(this.hasAttribute("stylesheet")){const e=document.createElement("link");e.rel="stylesheet",e.href=this.getAttribute("stylesheet"),n.push(e)}let o=n.length;for(let e of n)e.addEventListener("load",(()=>0==--o&&t.ready(s)));this.shadow.prepend(...n);const s=()=>{const e=[["Arrow",{location:1,width:8,length:12}],["Label",{location:0,cssClass:"bp--pointer-source"}]];for(const n of this.arrowBindings)"unknown"!==n.side?("Top"===n.side&&(n.to.style.width="2em"),t.connect({source:n.from,target:n.to,anchors:["Center",n.side],overlays:e,connector:"Straight",endpoint:"Blank"}),"Top"===n.side&&(n.to.style.width="")):t.connect({source:n.from,target:n.to,anchors:["Center",["Continuous",{faces:["top","left","bottom"]}]],overlays:e,connector:[n.from.parentElement.parentElement===n.to.parentElement.parentElement?"StateMachine":"Bezier",{curviness:40,proximityLimit:0,margin:.01}],endpoint:"Blank"});for(const e of this.slashes)t.connect({source:e,target:e,anchors:["TopRight","BottomLeft"],connector:"Straight",endpoint:"Blank"});const n=this.getBoundingClientRect();for(const e of this.shadow.querySelectorAll(".jtk-overlay, .jtk-endpoint, .jtk-connector"))e.style.top=+e.style.top.slice(0,-2)-n.top-window.scrollY+"px",e.style.left=+e.style.left.slice(0,-2)-n.left-window.scrollX+"px";this.classList.add("bp--loaded")}}getChildren(e,t=!1){return[...e.childNodes].flatMap((n=>{if(n instanceof HTMLElement)return a.has(n.tagName)?[n]:(console.error("Found unexpected element %o in %o. Did you misspell a tag name?",n,e),[]);switch(n.nodeType){case Node.TEXT_NODE:const o=n.nodeValue?.trim();if(o){if(t)return[...o.matchAll(/\S+/g)].map((e=>e[0]));console.error("Found text %o in %o. Did you mean to use <lisp></lisp>?",n,e)}break;case Node.COMMENT_NODE:break;default:console.error("Found unexpected node %o in %o.",n,e)}return[]}))}search(t,n){const o=new Set,s=t=>{if(!o.has(t))switch(o.add(t),n(t),t.kind){case e.Single:t.contents.kind===l.Pointer&&s(t.contents.target);break;case e.Pair:t.lhs.kind===l.Pointer&&s(t.lhs.target),t.rhs.kind===l.Pointer&&s(t.rhs.target)}};s(t)}calculateGraphFromDOM(){const e={},n=[],s=[],a=new Set,f=Symbol(),g={},m=this.getChildren(this),b=new Set;let w=f;const y=n=>{let s;switch(n.tagName){case r.Box:let[e,...a]=this.getChildren(n,!0);for(const e of a)"string"==typeof e?console.error("Found extraneous text node %o in %o could be interpreted as a value.",e,n):console.error("Found extraneous element %o in %o.",e,n);e?s=t({contents:"string"==typeof e?h({value:e}):v(e)}):(console.error("<box> element %o contains no values, expected one.",n),s=t({contents:u}));break;case r.Pair:{const[e,t,...r]=this.getChildren(n,!0);for(const e of r)"string"==typeof e?console.error("Found extraneous text node %o in %o could be interpreted as a value.",e,n):console.error("Found extraneous element %o in %o.",e,n);t?e?s=o({lhs:"string"==typeof e?h({value:e}):v(e),rhs:"string"==typeof t?h({value:t}):v(t)}):(console.error("<pair> element %o contains no values, expected two.",n),s=o({lhs:u,rhs:u})):(console.error("<pair> element %o only contains one value, expected two.",n),s=o({lhs:"string"==typeof e?h({value:e}):v(e),rhs:u}));break}case r.List:{const e=this.getChildren(n,!0);if(0===e.length)s=t({contents:u});else if(n.hasAttribute(i.ExplicitTail)){const t=e[e.length-1],n="string"==typeof t?h({value:t}):v(t);s=e.slice(0,-1).reduceRight(((e,t)=>o({lhs:"string"==typeof t?h({value:t}):v(t),rhs:null===e?n:c({target:e})})),null)}else s=e.reduceRight(((e,t)=>o({lhs:"string"==typeof t?h({value:t}):v(t),rhs:null===e?u:c({target:e})})),null);break}case r.Lisp:{n.childNodes.forEach((e=>{[Node.TEXT_NODE,Node.COMMENT_NODE].includes(e.nodeType)||console.error("<lisp> elements can only contain text, but found %o in %o.",e,n)}));const e=e=>e instanceof p.SExpression?c({target:r(e)}):null==e?u:h({value:e}),r=t=>o({lhs:e(t.head),rhs:e(t.tail)}),i=(0,p.parse)(n.innerText).head;i instanceof p.SExpression?s=r(i):(console.error("%o is not valid content for a <lisp> element. Did you mean to surround it with parentheses?",n.innerText),s=t({contents:u}));break}default:console.error("Found <%s> element, but only <box>, <pair>, <list>, and <lisp> elements are permitted here.",n.tagName.toLowerCase()),s=t({contents:v(n)})}const a=n.getAttribute(i.Name);return a&&(e[a]=s),null!==n.getAttribute(i.ForceRoot)&&b.add(s),s},v=t=>{switch(t.tagName){case r.Pointer:{t.childNodes.length>0&&console.error("<pointer> element %o cannot have any children.",t);const o=t.getAttribute(i.Ref);if(!o)return console.error("<pointer> element %o must have a ref attribute, but is missing one.",t),u;if((g[o]??(g[o]=new Set)).add(w),o in e)return c({target:e[o]});const s={kind:l.Pointer};return n.push((()=>{o in e?d(s,c({target:e[o]})):(console.error("<pointer> element %o has ref=%o, but no element with that name exists.",t,o),d(s,u))})),s}case r.Value:return o={children:t.childNodes},{...o,kind:l.Rich};case r.Empty:return u}var o;return c({target:y(t)})};for(const e of m){const t=e.getAttribute(i.Name);w=t??f;const n=y(e);!t||b.has(n)?s.push(n):a.add(t)}for(const e of b)s.includes(e)||s.push(e);for(const e of n)e();for(;;){const t=new Set([...a].map((t=>e[t])));for(const e of s)this.search(e,(e=>t.delete(e)));if(0===t.size)break;const n=new Map;for(const e of t)n.set(e,0);for(const e of t)this.search(e,(e=>{n.has(e)&&n.set(e,n.get(e)+1)}));const o=[];for(const[e,t]of n.entries())(o[t]??(o[t]=[])).push(e);for(let e=0;e<o.length;e++){const t=o[e];if(t&&t.length>0){if(0===e)for(const e of t)s.push(e);else s.push(t[0]);break}}}return s}pushRow(e){const t=document.createElement("div");t.classList.add("bp--row");for(const n of e){const e=n.cloneNode(!0);e.classList.add("bp--hidden"),t.appendChild(e)}return this.rows.push(t),t}prepareRenderRoot(e){this.objectToPreparedEltBindings.set(e,document.createElement("div"))}renderFromBoxObject(t,n,o=!1){let s=this.objectToPreparedEltBindings.get(t);if(!o&&s)return s;const r=n.childElementCount,i=document.createElement("div");let a,c,d;switch(i.classList.add("bp--box-container"),n.appendChild(i),this.objectToEltBindings.set(t,i),t.kind){case e.Single:c=t.contents;break;case e.Pair:a=t.lhs,c=t.rhs}let h=!1;if(a)switch(d=s??document.createElement("div"),d.classList.add("bp--box"),i.prepend(d),a.kind){case l.Empty:this.slashes.push(d);break;case l.String:const e=document.createElement("span");e.classList.add("bp--value-container"),e.innerText=a.value,d.appendChild(e);break;case l.Rich:for(const e of a.children)d.appendChild(e);break;case l.Pointer:const t=this.objectToEltBindings.get(a.target);t?this.arrowBindings.push({from:d,to:t,side:"unknown"}):h=!0}let u=a?document.createElement("div"):s??document.createElement("div");switch(u.classList.add("bp--box"),i.appendChild(u),c.kind){case l.Empty:this.slashes.push(u);break;case l.String:const e=document.createElement("span");e.classList.add("bp--value-container"),e.innerText=c.value,u.appendChild(e);break;case l.Rich:for(const e of c.children)u.appendChild(e);break;case l.Pointer:const t=this.objectToEltBindings.get(c.target);if(t)this.arrowBindings.push({from:u,to:t,side:"unknown"});else{const e=this.renderFromBoxObject(c.target,n);this.arrowBindings.push({from:u,to:e,side:e.classList.contains("bp--box")?"Left":"unknown"})}}if(h){const e=this.renderFromBoxObject(a.target,this.pushRow([...n.children].slice(0,r)));this.arrowBindings.push({from:d,to:e,side:e.classList.contains("bp--box")?"Top":"unknown"})}return d??u}})})()})();